<!DOCTYPE html>
<html>
  <head>
    <title>GLTF Loader Test</title>
    <link rel="stylesheet" href="styles/tachyons.min.css" />
    <link rel="stylesheet" href="styles/main.css" />
    <script src="../node_modules/@zeainc/zea-engine/dist/index.umd.js"></script>

    <script src="https://www.gstatic.com/draco/v1/decoders/draco_decoder_gltf.js"></script>
    <script src="../dist/index.umd.js"></script>
  </head>
  <body>
    <canvas class="full-size" id="app"></canvas>
    <div id="dropZoneWrapper">
      <div id="dropZone">
      <form class="my-form">
        <p>Drag and drop a GLTF file to view</p>
        <input type="file" id="fileElem" multiple accept="*.glb" onchange="handleFiles(this.files)" />
        <label class="button" for="fileElem">Select a GLTF file</label>
      </form>
    </div>

    <script type="module">
      const {
        GLRenderer,
        Scene,
        Vec3,
        Xfo,
        Color,
        Sphere,
        Material,
        GeomItem,
        GLBoundingBoxPass,
        EnvMap,
        resourceLoader,
      } = zeaEngine

      const scene = new Scene()
      const renderer = new GLRenderer(document.getElementById('app'), { hideSplash: true, xrCompatible: false })
      renderer.setScene(scene)
      scene.setupGrid(10, 10)

      const envMap = new EnvMap()
      envMap.getParameter('FilePath').setValue('data/pisa.zenv')
      scene.setEnvMap(envMap)
      scene.getSettings().getParameter('Display EnvMap').setValue(false)
      renderer.exposure = 1.5

      // /////////////////////////////////////
      // Setup a Bounding Box pass to display all
      // the bounding boxes of the items in the scene.
      // const boundingBoxPass = new GLBoundingBoxPass()
      // renderer.addPass(boundingBoxPass)
      // boundingBoxPass.addTreeItem(scene.getRoot(), true)

      // /////////////////////////////////////
      // Setup the custom classes
      // The custom pass to handle rendering, and add a custom
      // TreeItem to the scene tree
      const { GLTFAsset } = gltfLoader

      let prevProgress = 0
      resourceLoader.on('progressIncremented', (event) => {
        const percent = Math.round(event.percent)
        if (percent != prevProgress) {
          console.log(percent)
          prevProgress = percent
        }
      })

      const loadGLTF = (url, filename) => {

        document.getElementById('dropZone').classList.add('hidden')

        const asset = new GLTFAsset('gltf')
        asset.load(url, filename).then(() => {
          console.log('Loading done')
          const xfo = new Xfo()
          const box = asset.getParameter('BoundingBox').getValue()
          if (urlParams.has('y2zup')) {
            xfo.ori.setFromAxisAndAngle(new Vec3(1, 0, 0), Math.PI * 0.5)
            xfo.tr.z = -box.p0.y
          } else {
            xfo.tr.z = -box.p0.z
          }
          asset.getParameter('LocalXfo').setValue(xfo)
          renderer.frameAll()
        })

        if (scene.getRoot().getNumChildren() > 1) scene.getRoot().removeChild(1)
        scene.getRoot().addChild(asset)
      }

      const urlParams = new URLSearchParams(window.location.search)
      if (urlParams.has('gltf')) {
        loadGLTF(urlParams.get('gltf'))
      }


      // /////////////////////////////////////
      // Check that pointer interactions work.
      let highlighted
      renderer.getViewport().on('pointerMove', (event) => {
        if (event.intersectionData) {
          const { geomItem, dist } = event.intersectionData
          if (geomItem != highlighted) {
            if (highlighted) highlighted.removeHighlight('custom')
            highlighted = geomItem
            highlighted.addHighlight('custom', new Color(0, 1, 0, 0.1))
          }
        } else {
          if (highlighted) highlighted.removeHighlight('custom')
          highlighted = null
        }
      })

      // /////////////////////////////////////
      // Drag-n-Drop support
      const dropZoneWrapper = document.getElementById('dropZoneWrapper')
      const dropArea = document.getElementById('dropZone')
      ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach((eventName) => {
        dropZoneWrapper.addEventListener(eventName, preventDefaults, false)
      })

      function preventDefaults(e) {
        e.preventDefault()
        e.stopPropagation()
      }
      ;['dragenter', 'dragover'].forEach((eventName) => {
        dropZoneWrapper.addEventListener(eventName, highlight, false)
      })
      ;['dragleave', 'drop'].forEach((eventName) => {
        dropZoneWrapper.addEventListener(eventName, unhighlight, false)
      })

      function highlight(e) {
        dropArea.classList.remove('hidden')
        dropArea.classList.add('highlight')
      }

      function unhighlight(e) {
        dropArea.classList.remove('highlight')
      }
      dropArea.addEventListener('drop', handleDrop, false)

      function handleDrop(e) {
        let dt = e.dataTransfer
        let files = dt.files

        handleFiles(files)
      }
      function handleFiles(files) {
        ([...files]).forEach((file) => {
          if (file) {
            const reader = new FileReader();

            reader.addEventListener("load", function () {
              // convert image file to base64 string
              loadGLTF(reader.result, file.name);
            }, false);

            reader.readAsDataURL(file);
          }
        })
      }
      window.handleFiles = handleFiles
      // /////////////////////////////////////
      // Prepare to capture images.
      // renderer.getViewport().getCamera().setPositionAndTarget(new Vec3(2, 2, 2), new Vec3(0, 0, 0.4))
      window.postMessage('done-loading')

      // {{{ Messages handler.
      const handleMessage = (event) => {
        const { data } = event

        if (data === 'variant-01') {
          renderer.once('redrawOccurred', () => {
            window.postMessage(`done-${data}`)
          })
        } else if (data === 'variant-02') {
          renderer.once('redrawOccurred', () => {
            window.postMessage(`done-${data}`)
          })
        }
      }

      window.addEventListener('message', handleMessage, false)
      // }}}
    </script>
  </body>
</html>
